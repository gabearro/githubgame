name: Validate Move

on:
  pull_request_target:
    branches: ['game/**', 'test-game/**']

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0

      - name: Validate Move
        id: validate
        uses: actions/github-script@v7
        with:
          script: |
            const prAuthor = context.payload.pull_request.user.login;
            const baseRef = context.payload.pull_request.base.ref;
            const headSha = context.payload.pull_request.head.sha;

            const { execSync } = require('child_process');
            const oldState = JSON.parse(
              execSync(`git show origin/${baseRef}:game.json`).toString()
            );

            const { data: newFile } = await github.rest.repos.getContent({
              owner: context.payload.pull_request.head.repo.owner.login,
              repo: context.payload.pull_request.head.repo.name,
              path: 'game.json',
              ref: headSha
            });
            const newState = JSON.parse(Buffer.from(newFile.content, 'base64').toString());

            if (oldState.winner) {
              core.setFailed(`Game already over. Winner: ${oldState.winner}`);
              return;
            }

            const expectedPlayer = oldState.players[oldState.turn];
            if (prAuthor !== expectedPlayer) {
              core.setFailed(`Not your turn! Waiting for ${expectedPlayer}, got ${prAuthor}`);
              return;
            }

            const changes = [];
            for (let i = 0; i < 9; i++) {
              if (oldState.board[i] !== newState.board[i]) {
                changes.push({ index: i, from: oldState.board[i], to: newState.board[i] });
              }
            }

            if (changes.length !== 1) {
              core.setFailed(`Must change exactly one cell. Found ${changes.length} changes.`);
              return;
            }

            const move = changes[0];

            if (move.from !== null) {
              core.setFailed(`Cell ${move.index} already occupied by ${move.from}`);
              return;
            }

            if (move.to !== oldState.turn) {
              core.setFailed(`Wrong symbol. Expected ${oldState.turn}, got ${move.to}`);
              return;
            }

            const nextTurn = oldState.turn === 'X' ? 'O' : 'X';
            if (newState.turn !== nextTurn && !newState.winner) {
              core.setFailed(`Turn should advance to ${nextTurn}`);
              return;
            }

            const lines = [
              [0,1,2], [3,4,5], [6,7,8],
              [0,3,6], [1,4,7], [2,5,8],
              [0,4,8], [2,4,6]
            ];
            let actualWinner = null;
            for (const [a,b,c] of lines) {
              if (newState.board[a] && newState.board[a] === newState.board[b] && newState.board[b] === newState.board[c]) {
                actualWinner = newState.board[a];
                break;
              }
            }
            if (newState.board.every(c => c !== null) && !actualWinner) {
              actualWinner = 'draw';
            }

            if (newState.winner !== actualWinner) {
              core.setFailed(`Winner should be ${actualWinner}, got ${newState.winner}`);
              return;
            }

            console.log(`âœ“ Valid move by ${prAuthor}: ${oldState.turn} -> cell ${move.index}`);
            if (actualWinner) {
              console.log(`Game over! Winner: ${actualWinner}`);
            }

            // Notify the game's issue if it exists
            if (oldState.issue) {
              const board = newState.board;
              const boardStr = [
                `\`${board[0]||'Â·'}\` \`${board[1]||'Â·'}\` \`${board[2]||'Â·'}\``,
                `\`${board[3]||'Â·'}\` \`${board[4]||'Â·'}\` \`${board[5]||'Â·'}\``,
                `\`${board[6]||'Â·'}\` \`${board[7]||'Â·'}\` \`${board[8]||'Â·'}\``
              ].join('\n');

              let msg = `**${prAuthor}** played ${oldState.turn} at cell ${move.index}\n\n${boardStr}`;
              if (actualWinner === 'draw') {
                msg += `\n\nğŸ¤ **Game Over - Draw!**`;
              } else if (actualWinner) {
                msg += `\n\nğŸ† **Game Over - ${actualWinner} wins!**`;
              } else {
                msg += `\n\nâ³ ${newState.players[newState.turn]}'s turn (${newState.turn})`;
              }

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: oldState.issue,
                body: msg
              });
            }

      - name: Auto-merge (production games only)
        if: success() && startsWith(github.event.pull_request.base.ref, 'game/')
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              merge_method: 'merge'
            });
            console.log(`âœ“ PR #${context.payload.pull_request.number} auto-merged`);
