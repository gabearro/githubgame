name: New Game

on:
  issues:
    types: [opened]

jobs:
  create-game:
    if: startsWith(github.event.issue.title, 'new game:')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create Game Branch
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.issue.title;
            const issueNumber = context.payload.issue.number;

            const match = title.match(/^new game:\s*(\S+)\s+vs\s+(\S+)$/i);
            if (!match) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `‚ùå Invalid format. Use: \`new game: player1 vs player2\``
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed'
              });
              return;
            }

            const [, playerX, playerO] = match;

            // Generate unique branch name with issue number + random suffix
            const randomSuffix = Math.random().toString(36).substring(2, 8);
            const branchName = `game/${playerX}-vs-${playerO}-${issueNumber}-${randomSuffix}`;

            const { data: mainRef } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });

            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branchName}`,
              sha: mainRef.object.sha
            });

            // Store issue number in game state for notifications
            const gameState = {
              board: [null, null, null, null, null, null, null, null, null],
              players: { X: playerX, O: playerO },
              turn: 'X',
              winner: null,
              issue: issueNumber
            };

            const { data: currentFile } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'game.json',
              ref: branchName
            });

            // Reference issue in commit message for notifications
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'game.json',
              message: `New game: ${playerX} (X) vs ${playerO} (O)\n\nCreated from #${issueNumber}`,
              content: Buffer.from(JSON.stringify(gameState, null, 2) + '\n').toString('base64'),
              sha: currentFile.sha,
              branch: branchName
            });

            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
            const branchUrl = `${repoUrl}/tree/${branchName}`;
            const gameJsonUrl = `${repoUrl}/blob/${branchName}/game.json`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                `‚úì Game created!`,
                ``,
                `**${playerX}** (X) vs **${playerO}** (O)`,
                ``,
                `üìÅ Branch: [\`${branchName}\`](${branchUrl})`,
                `üìÑ Game state: [game.json](${gameJsonUrl})`,
                ``,
                `${playerX} goes first. Fork the repo, edit \`game.json\`, and open a PR to make your move!`,
                ``,
                `_Subscribe to this issue to get notified of game updates._`
              ].join('\n')
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              labels: ['game-created']
            });
